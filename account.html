<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account – NIW Application Assistant</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <nav class="site-nav">
        <div class="site-nav-inner">
            <div class="nav-left"></div>
            <a class="site-brand" href="/">
                <img src="/TurboNIW-name-italic.png" alt="TurboNIW" class="brand-logo-text">
            </a>
            <div class="nav-right">
                <a class="nav-link" href="/account">Account</a>
                <a class="btn btn-outline" href="/evaluation">Free Evaluation</a>
                <button id="logoutBtn" class="btn btn-secondary" type="button" style="display:none;">Logout</button>
            </div>
        </div>
    </nav>
    <div class="container">

        <section id="authSection" class="auth-card">
            <div class="auth-header">
                <h1>Sign In</h1>
                <p>to start preparing your NIW application materials and track your progress</p>
            </div>
            <div class="auth-form">
                <div class="form-group">
                    <label for="accountEmail">Email Address</label>
                    <input type="email" id="accountEmail" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label for="accountPassword">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="accountPassword" placeholder="8–12 characters" minlength="8" maxlength="12" required>
                        <button type="button" id="togglePwd" class="password-toggle" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="auth-buttons">
                    <button id="loginBtn" class="btn btn-primary" type="button">Sign In</button>
                    <button id="registerBtn" class="btn btn-outline" type="button">Create Account</button>
                </div>
            </div>
        </section>

        <section id="dashboard" class="dashboard-container" style="display:none;">
            <div class="dashboard-header">
                <h2>Your NIW Journey</h2>
                <p>Complete your tasks in order to progress through your NIW application materials preparation.</p>
            </div>
            
            <div class="plan-card">
                <div class="plan-info">
                    <h3>Selected Plan</h3>
                    <p class="plan-name" id="planName">Complete NIW Preparation</p>
                    <p class="plan-price" id="planPrice">$1,599</p>
                    <p class="plan-description" id="planDescription">Form filling + Petition letter draft</p>
                </div>
            </div>

            <div class="progress-tracker">
                <div class="progress-header">
                    <h3>Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 25%"></div>
                    </div>
                    <span class="progress-text" id="progressText">1 of 4 steps completed</span>
                </div>
                
                <div class="steps-grid">
                    <div class="step-card" id="step-plan">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Select Package</h4>
                            <p>Choose your NIW preparation package</p>
                            <div id="packageSelection" style="margin-top: 12px; display: none;">
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button class="btn btn-outline" onclick="changePackage('form-filling')" id="formFillingBtn" style="font-size: 0.8rem; padding: 6px 12px;">Form Filling ($299)</button>
                                    <button class="btn btn-outline" onclick="changePackage('full')" id="fullPackageBtn" style="font-size: 0.8rem; padding: 6px 12px;">Full Package ($1,599)</button>
                                </div>
                            </div>
                        </div>
                        <div class="step-status">
                            <button id="changePackageBtn" class="btn btn-secondary" onclick="togglePackageSelection()" style="font-size: 0.8rem; padding: 4px 8px; display: none;">Change</button>
                        </div>
                    </div>

                    <div class="step-card" id="step-pay">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Make Payment</h4>
                            <p>Secure payment to unlock your services</p>
                        </div>
                        <div class="step-status">
                            <button id="payNowBtn" class="btn btn-success" type="button">Pay $1,599</button>
                        </div>
                    </div>

                    <div class="step-card disabled" id="step-survey">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4 id="surveyStepTitle">Complete Surveys</h4>
                            <p id="surveyStepDescription">Fill out surveys to prepare your petition letter</p>
                        </div>
                        <div class="step-status">
                            <!-- Form Filling Package - Only First Survey -->
                            <div id="formFillingButtons" class="survey-buttons" style="display: none;">
                                <a id="firstSurveyLinkForm" class="btn" href="/first-survey">First Survey</a>
                            </div>
                            
                            <!-- Full Package - Both Surveys -->
                            <div id="fullPackageButtons" class="survey-buttons" style="display: none;">
                                <a id="firstSurveyLinkFull" class="btn" href="/first-survey">First Survey</a>
                                <a id="secondSurveyLinkFull" class="btn" href="/survey">Second Survey</a>
                            </div>
                        </div>
                    </div>

                    <div class="step-card disabled" id="step-petition">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>Access Petition Letter</h4>
                            <p>Download your petition letter draft</p>
                        </div>
                        <div class="step-status">
                            <span class="status-badge coming-soon">Coming Soon</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer style="text-align:center; color:#64748b; padding: 24px;">
            <small>© 2025 TurboNIW</small>
        </footer>
    </div>

    <script>
        // Global refreshUI function
        // Global variable to store current package type
        let currentPackageType = 'full';

        // Function to show package selection interface
        function showPackageSelection() {
          const dashboard = document.getElementById('dashboard');
          const packageSelection = document.getElementById('packageSelection');
          
          if (dashboard) dashboard.style.display = 'none';
          if (packageSelection) packageSelection.style.display = 'block';
        }

        async function refreshUI() {
          console.log('refreshUI called');
          try {
            console.log('Fetching /api/me');
            const res = await fetch('/api/me');
            console.log('API /me response status:', res.status);
            const data = await res.json();
            console.log('API /me response data:', data);
            
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (!data.success || !data.user) {
              authSection.style.display = 'block';
              dashboard.style.display = 'none';
              logoutBtn.style.display = 'none';
              return;
            }
            
            const user = data.user;
            if (user) {
              authSection.style.display = 'none';
              dashboard.style.display = 'block';
              logoutBtn.style.display = 'inline-block';
              
              // Check for selected package in localStorage (from main page selection)
              const selectedPackage = localStorage.getItem('selectedPackage');
              let packageType = user.packageType;
              
              // If user has a selected package in localStorage and hasn't paid yet, use that
              if (selectedPackage && !user.paid) {
                console.log('Found selected package in localStorage:', selectedPackage);
                packageType = selectedPackage;
                
                // Set the package type on the server
                try {
                  const response = await fetch('/api/set-package', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ packageType: selectedPackage })
                  });
                  
                  const result = await response.json();
                  if (result.success) {
                    console.log('Package type set successfully:', selectedPackage);
                    // Clear localStorage after successful setting
                    localStorage.removeItem('selectedPackage');
                  } else {
                    console.error('Failed to set package type:', result.error);
                  }
                } catch (error) {
                  console.error('Error setting package type:', error);
                }
              }
              
              // If no package is selected yet, show package selection interface
              if (!packageType && !user.paid) {
                console.log('No package selected yet, showing package selection');
                showPackageSelection();
                return;
              }
              
              // Set global package type for payment button
              currentPackageType = packageType;
              
              // Update plan information based on package type
              const planName = document.getElementById('planName');
              const planPrice = document.getElementById('planPrice');
              const planDescription = document.getElementById('planDescription');
              
              if (packageType === 'form-filling') {
                if (planName) planName.textContent = 'Form Filling Package';
                if (planPrice) planPrice.textContent = '$299';
                if (planDescription) planDescription.textContent = 'Complete NIW application forms';
                
                // Update step 3 content for form filling package
                const surveyStepTitle = document.getElementById('surveyStepTitle');
                const surveyStepDescription = document.getElementById('surveyStepDescription');
                if (surveyStepTitle) surveyStepTitle.textContent = 'Complete One Survey';
                if (surveyStepDescription) surveyStepDescription.textContent = '';
                
                // Highlight selected package button
                const formFillingBtn = document.getElementById('formFillingBtn');
                const fullPackageBtn = document.getElementById('fullPackageBtn');
                if (formFillingBtn) formFillingBtn.style.background = '#2563eb';
                if (formFillingBtn) formFillingBtn.style.color = 'white';
                if (fullPackageBtn) fullPackageBtn.style.background = 'transparent';
                if (fullPackageBtn) fullPackageBtn.style.color = '#2563eb';
              } else {
                if (planName) planName.textContent = 'Complete NIW Preparation';
                if (planPrice) planPrice.textContent = '$1,599';
                if (planDescription) planDescription.textContent = 'Form filling + Petition letter draft';
                
                // Update step 3 content for full package
                const surveyStepTitle = document.getElementById('surveyStepTitle');
                const surveyStepDescription = document.getElementById('surveyStepDescription');
                if (surveyStepTitle) surveyStepTitle.textContent = 'Complete Two Surveys';
                if (surveyStepDescription) surveyStepDescription.textContent = '';
                
                // Highlight selected package button
                const formFillingBtn = document.getElementById('formFillingBtn');
                const fullPackageBtn = document.getElementById('fullPackageBtn');
                if (fullPackageBtn) fullPackageBtn.style.background = '#2563eb';
                if (fullPackageBtn) fullPackageBtn.style.color = 'white';
                if (formFillingBtn) formFillingBtn.style.background = 'transparent';
                if (formFillingBtn) formFillingBtn.style.color = '#2563eb';
              }
              
              // Update payment button text based on package type
              const payNowBtn = document.getElementById('payNowBtn');
              if (payNowBtn) {
                if (packageType === 'form-filling') {
                  payNowBtn.textContent = 'Pay $299';
                } else {
                  payNowBtn.textContent = 'Pay $1,599';
                }
              }

              // Steps state
              const stepPlan = document.getElementById('step-plan');
              const stepPay = document.getElementById('step-pay');
              const stepSurvey = document.getElementById('step-survey');
              const stepPetition = document.getElementById('step-petition');

              // Step 1: Select Package - always completed when user is logged in
              stepPlan.className = 'step-card completed';

              // Package change logic based on payment status
              const changePackageBtn = document.getElementById('changePackageBtn');
              if (user.paid) {
                // User has paid - show change button only for upgrades
                if (packageType === 'form-filling') {
                  // User paid $299 - can upgrade to $1,599
                  if (changePackageBtn) {
                    changePackageBtn.style.display = 'inline-block';
                    changePackageBtn.textContent = 'Upgrade to Full Package';
                  }
                } else {
                  // User paid $1,599 - no changes allowed
                  if (changePackageBtn) {
                    changePackageBtn.style.display = 'none';
                  }
                }
              } else {
                // User hasn't paid - can change package freely
                if (changePackageBtn) {
                  changePackageBtn.style.display = 'inline-block';
                  changePackageBtn.textContent = 'Change';
                }
              }

              // Update progress bar and text
              const progressFill = document.getElementById('progressFill');
              const progressText = document.getElementById('progressText');
              
              if (user.paid) {
                // Step 2: Payment - completed when user has paid
                stepPay.className = 'step-card completed';
                // Hide Pay button when paid and add payment status
                const payStatus = stepPay.querySelector('.step-status');
                if (payStatus) {
                  // Clear existing content
                  payStatus.innerHTML = '';
                  
                  // Add payment status badge
                  const paymentBadge = document.createElement('span');
                  paymentBadge.className = 'status-badge completed';
                  paymentBadge.textContent = packageType === 'form-filling' ? 'Paid $299' : 'Paid $1,599';
                  payStatus.appendChild(paymentBadge);
                }
                
                // Step 3: Survey - enabled when user has paid (but not completed yet)
                stepSurvey.className = 'step-card';
                setSurveyEnabled(true, packageType);
                
                // Step 4: Petition - disabled until surveys are completed
                stepPetition.className = 'step-card disabled';
                
                // Update progress - only 2 of 4 steps completed (Package + Payment)
                if (progressFill) progressFill.style.width = '50%';
                if (progressText) progressText.textContent = '2 of 4 steps completed';
              } else {
                // Step 2: Payment - show Pay button when not paid
                stepPay.className = 'step-card';
                const payStatus = stepPay.querySelector('.step-status');
                if (payStatus) {
                  // Remove Completed badge if present
                  const completedBadge = payStatus.querySelector('.completed-badge');
                  if (completedBadge) completedBadge.remove();
                  
                  // Ensure Pay button exists
                  if (!payStatus.querySelector('button')) {
                    const payBtn = document.createElement('button');
                    payBtn.id = 'payNowBtn';
                    payBtn.className = 'btn btn-success';
                    payBtn.type = 'button';
                    payBtn.textContent = packageType === 'form-filling' ? 'Pay $299' : 'Pay $1,599';
                    payStatus.appendChild(payBtn);
                  }
                }
                
                // Step 3: Survey - disabled when user hasn't paid
                stepSurvey.className = 'step-card disabled';
                setSurveyEnabled(false, packageType);
                
                // Step 4: Petition - disabled when user hasn't paid
                stepPetition.className = 'step-card disabled';
                
                // Update progress
                if (progressFill) progressFill.style.width = '25%';
                if (progressText) progressText.textContent = '1 of 4 steps completed';
              }
            }
          } catch (error) {
            console.error('Error refreshing UI:', error);
          }
        }

        // Global setSurveyEnabled function
        function setSurveyEnabled(enabled, packageType = 'full') {
          const formFillingButtons = document.getElementById('formFillingButtons');
          const fullPackageButtons = document.getElementById('fullPackageButtons');
          
          if (packageType === 'form-filling') {
            if (formFillingButtons) {
              formFillingButtons.style.display = enabled ? 'flex' : 'none';
            }
            if (fullPackageButtons) {
              fullPackageButtons.style.display = 'none';
            }
          } else {
            if (fullPackageButtons) {
              fullPackageButtons.style.display = enabled ? 'flex' : 'none';
            }
            if (formFillingButtons) {
              formFillingButtons.style.display = 'none';
            }
          }
        }

        // Function to mark surveys as completed and update progress
        function markSurveysCompleted() {
          const stepSurvey = document.getElementById('step-survey');
          const stepPetition = document.getElementById('step-petition');
          const progressFill = document.getElementById('progressFill');
          const progressText = document.getElementById('progressText');
          
          // Mark survey step as completed
          stepSurvey.className = 'step-card completed';
          
          // Enable petition step
          stepPetition.className = 'step-card';
          
          // Update progress to 3 of 4 steps completed
          if (progressFill) progressFill.style.width = '75%';
          if (progressText) progressText.textContent = '3 of 4 steps completed';
        }

        // Function to mark petition as completed
        function markPetitionCompleted() {
          const stepPetition = document.getElementById('step-petition');
          const progressFill = document.getElementById('progressFill');
          const progressText = document.getElementById('progressText');
          
          // Mark petition step as completed
          stepPetition.className = 'step-card completed';
          
          // Update progress to 4 of 4 steps completed
          if (progressFill) progressFill.style.width = '100%';
          if (progressText) progressText.textContent = '4 of 4 steps completed';
        }

        // Package selection functions
        function togglePackageSelection() {
            const packageSelection = document.getElementById('packageSelection');
            if (packageSelection.style.display === 'none') {
                packageSelection.style.display = 'block';
            } else {
                packageSelection.style.display = 'none';
            }
        }

        async function changePackage(packageType) {
            try {
                // Check if user is trying to upgrade from form-filling to full package
                const currentUser = await fetch('/api/me').then(res => res.json());
                if (currentUser.success && currentUser.user && currentUser.user.paid) {
                    const currentPackage = currentUser.user.packageType || 'full';
                    
                    if (currentPackage === 'form-filling' && packageType === 'full') {
                        // This is an upgrade - redirect to payment for the difference
                        const confirmUpgrade = confirm('Upgrade to Full Package? You will be charged the difference of $1,300.');
                        if (!confirmUpgrade) {
                            document.getElementById('packageSelection').style.display = 'none';
                            return;
                        }
                        
                        // Set package type and redirect to payment
                        await fetch('/api/set-package', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ packageType: packageType })
                        });
                        
                        // Redirect to payment
                        window.location.href = '/account';
                        return;
                    } else if (currentPackage === 'full' && packageType === 'form-filling') {
                        // Downgrade not allowed
                        alert('Cannot downgrade from Full Package. No changes allowed after payment.');
                        document.getElementById('packageSelection').style.display = 'none';
                        return;
                    }
                }
                
                // Regular package change (for unpaid users)
                const response = await fetch('/api/set-package', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ packageType: packageType })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Hide package selection
                    document.getElementById('packageSelection').style.display = 'none';
                    // Refresh the UI to show updated package info
                    await refreshUI();
                } else {
                    alert('Failed to change package: ' + result.error);
                }
            } catch (error) {
                console.error('Error changing package:', error);
                alert('Failed to change package. Please try again.');
            }
        }

      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Account page script starting');
        
        const authSection = document.getElementById('authSection');
        const emailInput = document.getElementById('accountEmail');
        const passwordInput = document.getElementById('accountPassword');
        const registerBtn = document.getElementById('registerBtn');
        const loginBtn = document.getElementById('loginBtn');
        const dashboard = document.getElementById('dashboard');
        
        // Debug: Check if elements are found
        console.log('Auth elements found:', {
          authSection: !!authSection,
          emailInput: !!emailInput,
          passwordInput: !!passwordInput,
          registerBtn: !!registerBtn,
          loginBtn: !!loginBtn,
          dashboard: !!dashboard
        });
        
        // Test: Add a simple click handler to see if JavaScript is working
        if (loginBtn) {
          console.log('Adding test click handler to login button');
          // Remove the test handler - it was interfering with the real login
          // loginBtn.addEventListener('click', function() {
          //   console.log('Login button clicked!');
          //   alert('Login button clicked - JavaScript is working!');
          // });
        }
        
      
      // payNowBtn declaration moved to global scope

      // Initialize Stripe
      let stripe = null;
      let stripePublishableKey = null;

      async function initializeStripe() {
        try {
          // Get Stripe publishable key from server
          const response = await fetch('/api/stripe-config');
          const data = await response.json();
          if (data.success && data.publishableKey) {
            stripePublishableKey = data.publishableKey;
            stripe = Stripe(stripePublishableKey);
          }
        } catch (error) {
          console.error('Error initializing Stripe:', error);
        }
      }

      async function fetchMe() {
        const res = await fetch('/api/me');
        const data = await res.json();
        return data.user || null;
      }

      function setSurveyEnabled(enabled, packageType = 'full') {
        const formFillingButtons = document.getElementById('formFillingButtons');
        const fullPackageButtons = document.getElementById('fullPackageButtons');
        
        if (packageType === 'form-filling') {
          // Show only form filling buttons
          if (formFillingButtons) {
            formFillingButtons.style.display = enabled ? 'flex' : 'none';
            const firstSurveyLink = document.getElementById('firstSurveyLinkForm');
            if (firstSurveyLink) {
              firstSurveyLink.style.pointerEvents = enabled ? 'auto' : 'none';
              firstSurveyLink.style.opacity = enabled ? '1' : '0.6';
            }
          }
          if (fullPackageButtons) {
            fullPackageButtons.style.display = 'none';
          }
        } else {
          // Show full package buttons (both surveys)
          if (fullPackageButtons) {
            fullPackageButtons.style.display = enabled ? 'flex' : 'none';
            const firstSurveyLink = document.getElementById('firstSurveyLinkFull');
            const secondSurveyLink = document.getElementById('secondSurveyLinkFull');
            if (firstSurveyLink) {
              firstSurveyLink.style.pointerEvents = enabled ? 'auto' : 'none';
              firstSurveyLink.style.opacity = enabled ? '1' : '0.6';
            }
            if (secondSurveyLink) {
              secondSurveyLink.style.pointerEvents = enabled ? 'auto' : 'none';
              secondSurveyLink.style.opacity = enabled ? '1' : '0.6';
            }
          }
          if (formFillingButtons) {
            formFillingButtons.style.display = 'none';
          }
        }
      }

      // Duplicate refreshUI function removed - using global one above


      // Show/Hide password toggle
      const togglePwd = document.getElementById('togglePwd');
      if (togglePwd) {
        let visible = false;
        togglePwd.addEventListener('click', () => {
          visible = !visible;
          passwordInput.type = visible ? 'text' : 'password';
          togglePwd.innerHTML = visible ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        });
      }

      if (registerBtn) {
        let isRegistering = false;
        registerBtn.addEventListener('click', async () => {
        if (isRegistering) {
          console.log('Registration already in progress, ignoring click');
          return;
        }
        
        console.log('Register button clicked!');
        isRegistering = true;
        registerBtn.disabled = true;
        registerBtn.textContent = 'Creating Account...';
        
        const email = (emailInput.value || '').trim().toLowerCase();
        const password = passwordInput.value || '';
        
        if (!email || !password) { 
          alert('Email and password required'); 
          isRegistering = false;
          registerBtn.disabled = false;
          registerBtn.textContent = 'Create Account';
          return; 
        }
        if (password.length < 8 || password.length > 12) { 
          alert('Password must be 8–12 characters.'); 
          isRegistering = false;
          registerBtn.disabled = false;
          registerBtn.textContent = 'Create Account';
          return; 
        }
        
        try {
          console.log('Making API call to /api/register');
          
          // Add timeout to prevent hanging
          const controller = new AbortController();
          const timeoutId = setTimeout(() => {
            console.log('Registration API call timed out after 10 seconds');
            controller.abort();
          }, 10000);
          
          const res = await fetch('/api/register', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ email, password }),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          console.log('Registration API response status:', res.status);
          
          if (!res.ok) {
            console.error('Registration API response not ok:', res.status, res.statusText);
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          
          const data = await res.json();
          console.log('Registration API response data:', data);
          
          if (!data.success) { 
            alert(data.error || 'Register failed'); 
            return; 
          }
          
          console.log('Registration successful, calling refreshUI');
          await refreshUI();
        } catch (error) {
          console.error('Registration error:', error);
          if (error.name === 'AbortError') {
            alert('Registration request timed out. Please try again.');
          } else {
            alert('Registration failed: ' + error.message);
          }
        } finally {
          isRegistering = false;
          registerBtn.disabled = false;
          registerBtn.textContent = 'Create Account';
        }
        });
      } else {
        console.error('Register button not found!');
      }

      if (loginBtn) {
        let isLoggingIn = false;
        loginBtn.addEventListener('click', async () => {
        if (isLoggingIn) {
          console.log('Login already in progress, ignoring click');
          return;
        }
        
        console.log('Real login button clicked!');
        isLoggingIn = true;
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing In...';
        
        const email = (emailInput.value || '').trim().toLowerCase();
        const password = passwordInput.value || '';
        
        console.log('Login attempt with email:', email);
        
        if (!email || !password) { 
          console.log('Missing email or password');
          alert('Email and password required'); 
          isLoggingIn = false;
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In';
          return; 
        }
        
        try {
          console.log('Making API call to /api/login');
          
          // Add timeout to prevent hanging
          const controller = new AbortController();
          const timeoutId = setTimeout(() => {
            console.log('API call timed out after 10 seconds');
            controller.abort();
          }, 10000);
          
          const res = await fetch('/api/login', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ email, password }),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          console.log('API response status:', res.status);
          
          const data = await res.json();
          console.log('API response data:', data);
          
          if (!res.ok) {
            console.error('API response not ok:', res.status, res.statusText);
            // Show the actual error message from the server
            const msg = document.getElementById('loginMessage') || (() => {
              const p = document.createElement('p');
              p.id = 'loginMessage';
              p.style.color = '#b91c1c';
              p.style.marginTop = '8px';
              loginBtn.parentElement.appendChild(p);
              return p;
            })();
            msg.textContent = data.error || `HTTP ${res.status}: ${res.statusText}`;
            return;
          }
          
          if (!data.success) {
            // Inline message near buttons instead of alert
            const msg = document.getElementById('loginMessage') || (() => {
              const p = document.createElement('p');
              p.id = 'loginMessage';
              p.style.color = '#b91c1c';
              p.style.marginTop = '8px';
              loginBtn.parentElement.appendChild(p);
              return p;
            })();
            msg.textContent = data.error || 'Login failed';
            return;
          }
          // Clear any error text on success
          const msg = document.getElementById('loginMessage');
          if (msg) msg.textContent = '';
          console.log('Login successful, calling refreshUI');
          await refreshUI();
        } catch (error) {
          console.error('Login error:', error);
          if (error.name === 'AbortError') {
            alert('Login request timed out. Please try again.');
          } else {
            alert('Login failed: ' + error.message);
          }
        } finally {
          isLoggingIn = false;
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In';
        }
        });
      } else {
        console.error('Login button not found!');
      }

      document.getElementById('payNowBtn')?.addEventListener('click', async () => {
        try {
          console.log('Payment button clicked, package type:', currentPackageType);
          const res = await fetch('/api/create-checkout-session', { 
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ packageType: currentPackageType })
          });
          const data = await res.json();
          if (!data.success || !data.url) { 
            alert(data.error || 'Failed to start checkout'); 
            return; 
          }
          window.location.href = data.url;
        } catch (error) {
          console.error('Payment error:', error);
          alert('Failed to start checkout');
        }
      });

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            try {
              await fetch('/api/logout', { method: 'POST' });
              // Clear URL parameters and redirect to clean account page
              window.history.replaceState({}, document.title, '/account');
              await refreshUI();
            } catch (error) {
              console.error('Logout failed:', error);
            }
        });
      }

      // Handle Stripe redirect results
      (async () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('success') === '1' && params.get('session_id')) {
          try {
            const r = await fetch(`/api/checkout/confirm?session_id=${encodeURIComponent(params.get('session_id'))}`);
            const d = await r.json();
            if (d && d.success && d.paid) {
              // Clear URL parameters first
              window.history.replaceState({}, document.title, '/account');
              // Show success message
              alert('Payment successful. Survey unlocked.');
            }
          } catch (error) {
            console.error('Payment confirmation failed:', error);
          }
        }
        // Always refresh UI after handling payment or on normal page load
        await refreshUI();
      })();

        // Initialize Stripe on page load
        initializeStripe();
      });
    </script>
</body>
</html>


