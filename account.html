<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account – NIW Application Assistant</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <nav class="site-nav">
        <div class="site-nav-inner">
            <div class="nav-left"></div>
            <a class="site-brand" href="/">
                <img src="/TurboNIW-name-italic.png" alt="TurboNIW" class="brand-logo-text">
            </a>
            <div class="nav-right">
                <a class="nav-link" href="/account">Account</a>
                <a class="btn btn-outline" href="/evaluation">Free Evaluation</a>
                <button id="logoutBtn" class="btn btn-secondary" type="button" style="display:none;">Logout</button>
            </div>
        </div>
    </nav>
    <div class="container">

        <section id="authSection" class="auth-card">
            <div class="auth-header">
                <h1>Sign In</h1>
                <p>to start preparing your NIW application materials and track your progress</p>
            </div>
            <div class="auth-form">
                <div class="form-group">
                    <label for="accountEmail">Email Address</label>
                    <input type="email" id="accountEmail" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label for="accountPassword">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="accountPassword" placeholder="8–12 characters" minlength="8" maxlength="12" required>
                        <button type="button" id="togglePwd" class="password-toggle" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="auth-buttons">
                    <button id="loginBtn" class="btn btn-primary" type="button">Sign In</button>
                    <button id="registerBtn" class="btn btn-outline" type="button">Create Account</button>
                </div>
            </div>
        </section>

        <section id="dashboard" class="dashboard-container" style="display:none;">
            <div class="dashboard-header">
                <h2>Your NIW Journey</h2>
                <p>Complete your tasks in order to progress through your NIW application materials preparation.</p>
            </div>
            
            <div class="plan-card">
                <div class="plan-info">
                    <h3>Selected Plan</h3>
                    <p class="plan-name">Complete NIW Prep</p>
                    <p class="plan-price">$1,599</p>
                    <p class="plan-description">Form filling + Petition letter</p>
                </div>
            </div>

            <div class="progress-tracker">
                <div class="progress-header">
                    <h3>Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 25%"></div>
                    </div>
                    <span class="progress-text" id="progressText">1 of 4 steps completed</span>
                </div>
                
                <div class="steps-grid">
                    <div class="step-card" id="step-plan">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Select Package</h4>
                            <p>Choose your NIW preparation package</p>
                        </div>
                        <div class="step-status">
                            <span class="status-badge completed">Completed</span>
                        </div>
                    </div>

                    <div class="step-card" id="step-pay">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Make Payment</h4>
                            <p>Secure payment to unlock your services</p>
                        </div>
                        <div class="step-status">
                            <button id="payNowBtn" class="btn btn-success" type="button">Pay $1,599</button>
                        </div>
                    </div>

                    <div class="step-card disabled" id="step-survey">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Complete Surveys</h4>
                            <p>Fill out both surveys to prepare your petition letter</p>
                        </div>
                        <div class="step-status">
                            <div class="survey-buttons">
                                <a id="firstSurveyLink" class="btn btn-secondary" href="/first-survey" style="pointer-events:none; opacity:0.6; margin-right: 8px;">First Survey</a>
                                <a id="secondSurveyLink" class="btn btn-secondary" href="/survey" style="pointer-events:none; opacity:0.6;">Second Survey</a>
                            </div>
                        </div>
                    </div>

                    <div class="step-card disabled" id="step-petition">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>Access Petition Letter</h4>
                            <p>Download your petition letter draft</p>
                        </div>
                        <div class="step-status">
                            <span class="status-badge coming-soon">Coming Soon</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer style="text-align:center; color:#64748b; padding: 24px;">
            <small>© 2025 TurboNIW</small>
        </footer>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const authSection = document.getElementById('authSection');
        const emailInput = document.getElementById('accountEmail');
        const passwordInput = document.getElementById('accountPassword');
        const registerBtn = document.getElementById('registerBtn');
        const loginBtn = document.getElementById('loginBtn');
        const dashboard = document.getElementById('dashboard');
        
      
      const payNowBtn = document.getElementById('payNowBtn');

      // Initialize Stripe
      let stripe = null;
      let stripePublishableKey = null;

      async function initializeStripe() {
        try {
          // Get Stripe publishable key from server
          const response = await fetch('/api/stripe-config');
          const data = await response.json();
          if (data.success && data.publishableKey) {
            stripePublishableKey = data.publishableKey;
            stripe = Stripe(stripePublishableKey);
          }
        } catch (error) {
          console.error('Error initializing Stripe:', error);
        }
      }

      async function fetchMe() {
        const res = await fetch('/api/me');
        const data = await res.json();
        return data.user || null;
      }

      function setSurveyEnabled(enabled) {
        const firstSurveyLink = document.getElementById('firstSurveyLink');
        const secondSurveyLink = document.getElementById('secondSurveyLink');
        
        if (firstSurveyLink) {
          firstSurveyLink.style.pointerEvents = enabled ? 'auto' : 'none';
          firstSurveyLink.style.opacity = enabled ? '1' : '0.6';
        }
        if (secondSurveyLink) {
          secondSurveyLink.style.pointerEvents = enabled ? 'auto' : 'none';
          secondSurveyLink.style.opacity = enabled ? '1' : '0.6';
        }
      }

      async function refreshUI() {
        const user = await fetchMe();
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Load configuration
        let config = {};
        try {
          const configRes = await fetch('/api/config');
          const configData = await configRes.json();
          if (configData.success) {
            config = configData.config;
            // Update survey step title based on config
            const surveyStep = document.querySelector('#step-survey h4');
            if (surveyStep && config.surveyTitle) {
              const surveyType = config.surveyType || 'full';
              surveyStep.textContent = config.surveyTitle[surveyType] || 'Fill Survey';
            }
          }
        } catch (e) {
          // Config loading failed, using defaults
        }
        
        if (user) {
          authSection.style.display = 'none';
          dashboard.style.display = 'block';
          logoutBtn.style.display = 'inline-block';
          
          // Steps state
          const stepPlan = document.getElementById('step-plan');
          const stepPay = document.getElementById('step-pay');
          const stepSurvey = document.getElementById('step-survey');
          const stepPetition = document.getElementById('step-petition');

          // Step 1: Select Package - always completed when user is logged in
          stepPlan.className = 'step-card completed';

          // Update progress bar and text
          const progressFill = document.getElementById('progressFill');
          const progressText = document.getElementById('progressText');
          
          if (user.paid) {
            // Step 2: Payment - completed when user has paid
            stepPay.className = 'step-card completed';
            // Hide Pay button when paid and add Completed status
            const payBtn = document.getElementById('payNowBtn');
            if (payBtn) {
              payBtn.style.display = 'none';
              // Add Completed status badge only if it doesn't exist
              const stepStatus = payBtn.parentElement;
              const existingBadge = stepStatus.querySelector('.status-badge.completed');
              if (!existingBadge) {
                const completedBadge = document.createElement('span');
                completedBadge.className = 'status-badge completed';
                completedBadge.textContent = 'Completed';
                stepStatus.appendChild(completedBadge);
              }
            }
            // Step 3: Survey - enabled when paid
            setSurveyEnabled(true);
            stepSurvey.className = 'step-card';
            
            // Update progress: 2 of 4 steps completed
            if (progressFill) progressFill.style.width = '50%';
            if (progressText) progressText.textContent = '2 of 4 steps completed';
          } else {
            // Step 2: Payment - current step when not paid
            stepPay.className = 'step-card';
            // Show Pay button
            const payBtn = document.getElementById('payNowBtn');
            if (payBtn) {
              payBtn.style.display = 'inline-block';
              // Remove any existing completed badge
              const stepStatus = payBtn.parentElement;
              const existingBadge = stepStatus.querySelector('.status-badge.completed');
              if (existingBadge) {
                existingBadge.remove();
              }
            }
            // Step 3: Survey - disabled when not paid
            setSurveyEnabled(false);
            stepSurvey.className = 'step-card disabled';
            
            // Update progress: 1 of 4 steps completed
            if (progressFill) progressFill.style.width = '25%';
            if (progressText) progressText.textContent = '1 of 4 steps completed';
          }

          stepPetition.className = 'step-card disabled';
        } else {
          dashboard.style.display = 'none';
          authSection.style.display = 'block';
          logoutBtn.style.display = 'none';
        }
      }

      // Show/Hide password toggle
      const togglePwd = document.getElementById('togglePwd');
      if (togglePwd) {
        let visible = false;
        togglePwd.addEventListener('click', () => {
          visible = !visible;
          passwordInput.type = visible ? 'text' : 'password';
          togglePwd.innerHTML = visible ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        });
      }

      registerBtn.addEventListener('click', async () => {
        const email = (emailInput.value || '').trim().toLowerCase();
        const password = passwordInput.value || '';
        
        if (!email || !password) { 
          alert('Email and password required'); 
          return; 
        }
        if (password.length < 8 || password.length > 12) { 
          alert('Password must be 8–12 characters.'); 
          return; 
        }
        
        try {
          const res = await fetch('/api/register', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ email, password }) 
          });
          const data = await res.json();
          if (!data.success) { 
            alert(data.error || 'Register failed'); 
            return; 
          }
          await refreshUI();
        } catch (error) {
          alert('Registration failed. Please try again.');
        }
      });

      loginBtn.addEventListener('click', async () => {
        const email = (emailInput.value || '').trim().toLowerCase();
        const password = passwordInput.value || '';
        
        if (!email || !password) { 
          alert('Email and password required'); 
          return; 
        }
        
        try {
          const res = await fetch('/api/login', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ email, password }) 
          });
          const data = await res.json();
          if (!data.success) {
            // Inline message near buttons instead of alert
            const msg = document.getElementById('loginMessage') || (() => {
              const p = document.createElement('p');
              p.id = 'loginMessage';
              p.style.color = '#b91c1c';
              p.style.marginTop = '8px';
              loginBtn.parentElement.appendChild(p);
              return p;
            })();
            msg.textContent = data.error || 'Login failed';
            return;
          }
          // Clear any error text on success
          const msg = document.getElementById('loginMessage');
          if (msg) msg.textContent = '';
          await refreshUI();
        } catch (error) {
          alert('Login failed. Please try again.');
        }
      });

      payNowBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/api/create-checkout-session', { method: 'POST' });
          const data = await res.json();
          if (!data.success || !data.url) { 
            alert(data.error || 'Failed to start checkout'); 
            return; 
          }
          window.location.href = data.url;
        } catch (error) {
          alert('Failed to start checkout');
        }
      });

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/api/logout', { method: 'POST' });
            await refreshUI();
          } catch (error) {
            console.error('Logout failed:', error);
          }
        });
      }

      // Handle Stripe redirect results
      (async () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('success') === '1' && params.get('session_id')) {
          try {
            const r = await fetch(`/api/checkout/confirm?session_id=${encodeURIComponent(params.get('session_id'))}`);
            const d = await r.json();
            if (d && d.success && d.paid) {
              alert('Payment successful. Survey unlocked.');
            }
          } catch (error) {
            console.error('Payment confirmation failed:', error);
          }
        }
        await refreshUI();
      })();

        // Initialize Stripe on page load
        initializeStripe();
      });
    </script>
</body>
</html>


