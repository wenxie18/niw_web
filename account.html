<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account – NIW Application Assistant</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <nav class="site-nav">
        <div class="site-nav-inner">
            <div class="nav-left"></div>
            <a class="site-brand" href="/">
                <img src="/TurboNIW-name-italic.png" alt="TurboNIW" class="brand-logo-text">
            </a>
            <div class="nav-right">
                <a class="nav-link" href="/account">Account</a>
                <a class="btn btn-outline" href="/evaluation">Free Evaluation</a>
                <button id="logoutBtn" class="btn btn-secondary" type="button" style="display:none;">Logout</button>
            </div>
        </div>
    </nav>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-user-circle"></i>
                <h1>My Account</h1>
            </div>
            <p class="subtitle">Create an account or sign in to access your NIW preparation tasks. Payments use Stripe test mode (sandbox).</p>
        </header>

        <section id="authSection" class="survey-form" style="padding: 32px; display:none;">
            <div class="section-header">
                <h2><i class="fas fa-right-to-bracket"></i> Create account / Sign in</h2>
                <p>Enter your email to access your dashboard.</p>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="accountEmail">Email</label>
                    <input type="email" id="accountEmail" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label for="accountPassword">Password</label>
                    <input type="password" id="accountPassword" placeholder="8–12 characters" minlength="8" maxlength="12">
                    <button type="button" id="togglePwd" class="password-toggle" aria-label="Toggle password visibility">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button id="registerBtn" class="btn btn-secondary" type="button">Create Account</button>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button id="loginBtn" class="btn btn-primary" type="button">Sign In</button>
                </div>
            </div>
        </section>

        <section id="dashboard" class="survey-form" style="padding: 32px; display:none;">
            <div class="section-header">
                <h2><i class="fas fa-list-check"></i> Your Tasks</h2>
                <p>Complete your tasks in order. Payment unlocks the survey.</p>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Plan Selected</label>
                    <p>Complete NIW Prep – $1,599 (Form filling + Petition letter)</p>
                </div>

                <div class="form-group full-width">
                    <label>Steps</label>
                    <ul id="stepsList" class="steps">
                        <li class="step" id="step-plan">
                            <div class="step-left">
                                <span class="step-index">1</span>
                                <span class="step-title">Select Package</span>
                            </div>
                            <div></div>
                        </li>
                        <li class="step" id="step-pay">
                            <div class="step-left">
                                <span class="step-index">2</span>
                                <span class="step-title">Make Payment</span>
                            </div>
                            <div>
                                <button id="payNowBtn" class="btn btn-success" type="button">Pay $1,599</button>
                            </div>
                        </li>
                        <li class="step" id="step-survey">
                            <div class="step-left">
                                <span class="step-index">3</span>
                                <span class="step-title">Fill Survey</span>
                            </div>
                            <div>
                                <a id="surveyLink" class="btn btn-secondary" href="/survey" style="pointer-events:none; opacity:0.6;">Go to Survey</a>
                            </div>
                        </li>
                        <li class="step" id="step-petition">
                            <div class="step-left">
                                <span class="step-index">4</span>
                                <span class="step-title">Access Petition Letter</span>
                            </div>
                            <div><span style="color:#64748b; font-weight:600;">Coming soon</span></div>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <footer style="text-align:center; color:#64748b; padding: 24px;">
            <small>© 2025 NIW Application Assistant. Simulated payment for development only.</small>
        </footer>
    </div>

    <script>
      const authSection = document.getElementById('authSection');
      const emailInput = document.getElementById('accountEmail');
      const passwordInput = document.getElementById('accountPassword');
      const registerBtn = document.getElementById('registerBtn');
      const loginBtn = document.getElementById('loginBtn');
      const dashboard = document.getElementById('dashboard');
      const paymentStatus = document.getElementById('paymentStatus');
      const payNowBtn = document.getElementById('payNowBtn');
      const surveyLink = document.getElementById('surveyLink');

      // Initialize Stripe
      let stripe = null;
      let stripePublishableKey = null;

      async function initializeStripe() {
        try {
          // Get Stripe publishable key from server
          const response = await fetch('/api/stripe-config');
          const data = await response.json();
          if (data.success && data.publishableKey) {
            stripePublishableKey = data.publishableKey;
            stripe = Stripe(stripePublishableKey);
          }
        } catch (error) {
          console.error('Error initializing Stripe:', error);
        }
      }

      async function fetchMe() {
        const res = await fetch('/api/me');
        const data = await res.json();
        return data.user || null;
      }

      function setSurveyEnabled(enabled) {
        surveyLink.style.pointerEvents = enabled ? 'auto' : 'none';
        surveyLink.style.opacity = enabled ? '1' : '0.6';
      }

      async function refreshUI() {
        const user = await fetchMe();
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Load configuration
        let config = {};
        try {
          const configRes = await fetch('/api/config');
          const configData = await configRes.json();
          if (configData.success) {
            config = configData.config;
            // Update survey step title based on config
            const surveyStep = document.querySelector('#step-survey .step-title');
            if (surveyStep && config.surveyTitle) {
              const surveyType = config.surveyType || 'full';
              surveyStep.textContent = config.surveyTitle[surveyType] || 'Fill Survey';
            }
          }
        } catch (e) {
          console.log('Could not load config, using defaults');
        }
        
        if (user) {
          authSection.style.display = 'none';
          dashboard.style.display = 'block';
          logoutBtn.style.display = 'inline-block';
          
          // Steps state
          const stepPlan = document.getElementById('step-plan');
          const stepPay = document.getElementById('step-pay');
          const stepSurvey = document.getElementById('step-survey');
          const stepPetition = document.getElementById('step-petition');

          stepPlan.className = 'step completed';

          if (user.paid) {
            stepPay.className = 'step completed';
            // Hide Pay button when paid
            const payBtn = document.getElementById('payNowBtn');
            if (payBtn) payBtn.style.display = 'none';
            // Enable survey
            setSurveyEnabled(true);
            stepSurvey.className = 'step current';
          } else {
            stepPay.className = 'step current';
            setSurveyEnabled(false);
            stepSurvey.className = 'step pending';
          }

          stepPetition.className = 'step pending';
        } else {
          dashboard.style.display = 'none';
          authSection.style.display = 'block';
          logoutBtn.style.display = 'none';
        }
      }

      // Show/Hide password toggle
      const togglePwd = document.getElementById('togglePwd');
      if (togglePwd) {
        let visible = false;
        togglePwd.addEventListener('click', () => {
          visible = !visible;
          passwordInput.type = visible ? 'text' : 'password';
          togglePwd.innerHTML = visible ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        });
      }

      registerBtn.addEventListener('click', async () => {
        const email = (emailInput.value || '').trim().toLowerCase();
        const password = passwordInput.value || '';
        if (!email || !password) { alert('Email and password required'); return; }
        if (password.length < 8 || password.length > 12) { alert('Password must be 8–12 characters.'); return; }
        const res = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const data = await res.json();
        if (!data.success) { alert(data.error || 'Register failed'); return; }
        await refreshUI();
      });

      loginBtn.addEventListener('click', async () => {
        const email = (emailInput.value || '').trim().toLowerCase();
        const password = passwordInput.value || '';
        if (!email || !password) { alert('Email and password required'); return; }
        const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const data = await res.json();
        if (!data.success) {
          // Inline message near buttons instead of alert
          const msg = document.getElementById('loginMessage') || (() => {
            const p = document.createElement('p');
            p.id = 'loginMessage';
            p.style.color = '#b91c1c';
            p.style.marginTop = '8px';
            loginBtn.parentElement.appendChild(p);
            return p;
          })();
          msg.textContent = data.error || 'Login failed';
          return;
        }
        // Clear any error text on success
        const msg = document.getElementById('loginMessage');
        if (msg) msg.textContent = '';
        await refreshUI();
      });

      payNowBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/api/create-checkout-session', { method: 'POST' });
          const data = await res.json();
          if (!data.success || !data.url) { alert(data.error || 'Failed to start checkout'); return; }
          window.location.href = data.url;
        } catch (e) {
          alert('Failed to start checkout');
        }
      });

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          await fetch('/api/logout', { method: 'POST' });
          await refreshUI();
        });
      }

      // Handle Stripe redirect results
      (async () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('success') === '1' && params.get('session_id')) {
          try {
            const r = await fetch(`/api/checkout/confirm?session_id=${encodeURIComponent(params.get('session_id'))}`);
            const d = await r.json();
            if (d && d.success && d.paid) {
              alert('Payment successful. Survey unlocked.');
            }
          } catch (e) {}
        } else if (params.get('canceled') === '1') {
          // no-op, user canceled
        }
        await refreshUI();
      })();

      // Initialize Stripe on page load
      initializeStripe();
    </script>
</body>
</html>


